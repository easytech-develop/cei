# Feature de Usu√°rios

Esta documenta√ß√£o descreve a feature de gerenciamento de usu√°rios do sistema, incluindo usu√°rios e fun√ß√µes (roles).

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Tabelas do Schema](#tabelas-do-schema)
- [Estrutura de Arquivos](#estrutura-de-arquivos)
- [Funcionalidades](#funcionalidades)
- [APIs](#apis)
- [Componentes](#componentes)
- [Valida√ß√µes](#valida√ß√µes)
- [Permiss√µes](#permiss√µes)

## üéØ Vis√£o Geral

A feature de usu√°rios permite o gerenciamento completo de usu√°rios e fun√ß√µes do sistema, incluindo:

- **CRUD de Usu√°rios**: Criar, listar, atualizar e excluir usu√°rios
- **CRUD de Fun√ß√µes**: Criar, listar, atualizar e excluir fun√ß√µes
- **Gerenciamento de Fun√ß√µes**: Associar usu√°rios a m√∫ltiplos fun√ß√µes espec√≠ficos
- **Controle de Status**: Ativar/suspender usu√°rios
- **Soft Delete**: Exclus√£o l√≥gica com possibilidade de restaura√ß√£o
- **Valida√ß√µes**: Valida√ß√£o de dados e regras de neg√≥cio
- **Interface Responsiva**: Interface moderna com tabela de dados
- **Sele√ß√£o M√∫ltipla de Roles**: Interface avan√ßada com popover e command para sele√ß√£o de fun√ß√µes

## üóÑÔ∏è Tabelas do Schema

### User
Tabela principal de usu√°rios do sistema.

```prisma
model User {
  id           String     @id @default(uuid(7))
  name         String
  email        String     @unique
  passwordHash String
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  Roles           UserRole[]
  UserPermissions UserPermission[]
  AuditLogs       AuditLog[]

  // NextAuth fields
  emailVerified DateTime?
  image         String?
}
```

**Campos:**
- `id`: Identificador √∫nico do usu√°rio (UUID v7)
- `name`: Nome completo do usu√°rio
- `email`: Email √∫nico do usu√°rio
- `passwordHash`: Hash da senha (bcrypt)
- `status`: Status do usu√°rio (ACTIVE/SUSPENDED)
- `createdAt`: Data de cria√ß√£o
- `updatedAt`: Data da √∫ltima atualiza√ß√£o
- `deletedAt`: Data de exclus√£o (soft delete)
- `emailVerified`: Data de verifica√ß√£o do email (NextAuth)
- `image`: URL da imagem do usu√°rio (NextAuth)

### Role
Tabela de fun√ß√µes/fun√ß√µes do sistema.

```prisma
model Role {
  id        String   @id @default(uuid(7))
  slug      String   @unique // "ADMIN", "DIRECTOR", "SECRETARY", "TEACHER"
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  RolePermissions RolePermission[]
  Users           UserRole[]
}
```

**Campos:**
- `id`: Identificador √∫nico do fun√ß√£o (UUID v7)
- `slug`: Slug √∫nico do fun√ß√£o (ex: "ADMIN", "DIRECTOR")
- `name`: Nome descritivo do fun√ß√£o
- `createdAt`: Data de cria√ß√£o
- `updatedAt`: Data da √∫ltima atualiza√ß√£o

### UserRole
Tabela de relacionamento entre usu√°rios e fun√ß√µes (N:N).

```prisma
model UserRole {
  userId    String
  roleId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)
  Role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}
```

**Campos:**
- `userId`: ID do usu√°rio
- `roleId`: ID do fun√ß√£o
- `createdAt`: Data de cria√ß√£o da associa√ß√£o
- `updatedAt`: Data da √∫ltima atualiza√ß√£o
- `deletedAt`: Data de exclus√£o da associa√ß√£o (soft delete)

**Relacionamentos:**
- Um usu√°rio pode ter m√∫ltiplos fun√ß√µes
- Um fun√ß√£o pode ser atribu√≠do a m√∫ltiplos usu√°rios
- Exclus√£o em cascata quando usu√°rio ou fun√ß√£o √© removido

## üìÅ Estrutura de Arquivos

```
src/app/(main)/(feature-users)/
‚îú‚îÄ‚îÄ README.md                    # Esta documenta√ß√£o
‚îú‚îÄ‚îÄ (pages)/users/               # P√°gina principal de usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                # P√°gina de listagem
‚îÇ   ‚îî‚îÄ‚îÄ _components/            # Componentes da interface
‚îÇ       ‚îú‚îÄ‚îÄ create-user.tsx     # Modal de cria√ß√£o
‚îÇ       ‚îú‚îÄ‚îÄ delete-user.tsx     # Modal de exclus√£o
‚îÇ       ‚îú‚îÄ‚îÄ list-users.tsx      # Tabela de usu√°rios
‚îÇ       ‚îî‚îÄ‚îÄ update-user.tsx     # Modal de edi√ß√£o
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ users.ts                # Tipos TypeScript
‚îú‚îÄ‚îÄ queries/
‚îÇ   ‚îú‚îÄ‚îÄ users.ts                # Hooks React Query para usu√°rios
‚îÇ   ‚îî‚îÄ‚îÄ roles.ts                # Hooks React Query para fun√ß√µes
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îî‚îÄ‚îÄ users.ts                # Fun√ß√µes server-side (APIs)
‚îî‚îÄ‚îÄ validators/
    ‚îî‚îÄ‚îÄ users.ts                # Schemas de valida√ß√£o Zod
```

## ‚öôÔ∏è Funcionalidades

### 1. Listagem de Usu√°rios
- **Pagina√ß√£o**: Suporte a pagina√ß√£o com limite configur√°vel
- **Busca**: Busca por nome e email
- **Filtros**: Filtro por fun√ß√µes espec√≠ficos com sele√ß√£o m√∫ltipla
- **Ordena√ß√£o**: Ordena√ß√£o por data de cria√ß√£o e nome
- **Status**: Exibe apenas usu√°rios ativos (n√£o deletados)
- **Exibi√ß√£o de Roles**: Mostra no m√°ximo 2 roles por usu√°rio com indicador "+X" para roles adicionais

### 2. Cria√ß√£o de Usu√°rio
- **Valida√ß√µes**: Valida√ß√£o de campos obrigat√≥rios
- **Email √önico**: Verifica√ß√£o de email duplicado
- **Restaura√ß√£o**: Restaura usu√°rio deletado se email existir
- **Hash de Senha**: Senha criptografada com bcrypt
- **Sele√ß√£o M√∫ltipla de Roles**: Interface com popover e command para sele√ß√£o de m√∫ltiplos fun√ß√µes
- **Valida√ß√£o de Roles**: Pelo menos um fun√ß√£o √© obrigat√≥rio

### 3. Atualiza√ß√£o de Usu√°rio
- **Valida√ß√µes**: Valida√ß√£o de dados de entrada
- **Email √önico**: Verifica√ß√£o de email duplicado (exceto pr√≥prio)
- **Transa√ß√£o**: Atualiza√ß√£o at√¥mica de usu√°rio e fun√ß√µes
- **Sele√ß√£o M√∫ltipla de Roles**: Interface consistente com cria√ß√£o
- **Auditoria**: Registro de altera√ß√µes

### 4. Exclus√£o de Usu√°rio
- **Soft Delete**: Exclus√£o l√≥gica (marca deletedAt)
- **Valida√ß√£o**: Verifica se usu√°rio existe e n√£o est√° deletado
- **Auditoria**: Registro da exclus√£o

### 5. Gerenciamento de Fun√ß√µes
- **Listagem**: Lista todos os fun√ß√µes dispon√≠veis
- **Associa√ß√£o M√∫ltipla**: Associa usu√°rios a m√∫ltiplos fun√ß√µes espec√≠ficos
- **Valida√ß√£o**: Verifica se fun√ß√£o existe
- **Interface Avan√ßada**: Popover com command para melhor UX

### 6. CRUD de Fun√ß√µes
- **Listagem de Fun√ß√µes**: Lista fun√ß√µes com pagina√ß√£o e busca
- **Cria√ß√£o de Fun√ß√£o**: Cria novos fun√ß√µes com valida√ß√£o de slug √∫nico
- **Atualiza√ß√£o de Fun√ß√£o**: Atualiza informa√ß√µes de fun√ß√µes existentes
- **Exclus√£o de Fun√ß√£o**: Exclui fun√ß√µes (apenas se n√£o houver usu√°rios associados)
- **Valida√ß√µes**: Valida√ß√£o de nome e slug obrigat√≥rios
- **Slug √önico**: Verifica√ß√£o de slug duplicado
- **Prote√ß√£o**: Impede exclus√£o de fun√ß√µes com usu√°rios associados

## üîå APIs

### getUsers
Lista usu√°rios com pagina√ß√£o e filtros.

```typescript
getUsers({
  meta: { page: 1, limit: 10 },
  filters?: {
    search?: string;
    roles?: string[];
  }
})
```

**Retorna:**
```typescript
{
  success: boolean;
  message: string;
  data?: {
    users: UserWithRoles[];
    meta: Meta;
  };
}
```

### createUser
Cria um novo usu√°rio.

```typescript
createUser({
  name: string;
  email: string;
  password: string;
  status: "ACTIVE" | "SUSPENDED";
  roles: string[]; // Array de IDs de roles
})
```

### updateUser
Atualiza um usu√°rio existente.

```typescript
updateUser(id: string, {
  name: string;
  email: string;
  status: "ACTIVE" | "SUSPENDED";
  roles: string[]; // Array de IDs de roles
})
```

### deleteUser
Exclui um usu√°rio (soft delete).

```typescript
deleteUser(id: string)
```

### getRoles
Lista fun√ß√µes com pagina√ß√£o e filtros.

```typescript
getRoles({
  meta: { page: 1, limit: 10 },
  filters?: {
    search?: string;
  }
})
```

**Retorna:**
```typescript
{
  success: boolean;
  message: string;
  data?: {
    roles: Role[];
    meta: Meta;
  };
}
```

### createRole
Cria um novo fun√ß√£o.

```typescript
createRole({
  name: string;
  slug: string;
})
```

### updateRole
Atualiza um fun√ß√£o existente.

```typescript
updateRole(id: string, {
  name: string;
  slug: string;
})
```

### deleteRole
Exclui um fun√ß√£o (apenas se n√£o houver usu√°rios associados).

```typescript
deleteRole(id: string)
```

## üß© Componentes

### ListUsers
Tabela responsiva com listagem de usu√°rios.

**Funcionalidades:**
- Pagina√ß√£o autom√°tica
- Busca em tempo real
- Filtros por fun√ß√£o com sele√ß√£o m√∫ltipla
- A√ß√µes de edi√ß√£o e exclus√£o
- Persist√™ncia de estado no localStorage
- **Exibi√ß√£o limitada de roles**: M√°ximo 2 roles vis√≠veis com indicador "+X"

### CreateUser
Modal para cria√ß√£o de usu√°rios.

**Campos:**
- Nome (obrigat√≥rio)
- Email (obrigat√≥rio, √∫nico)
- Senha (obrigat√≥rio, m√≠nimo 6 caracteres)
- Status (ACTIVE/SUSPENDED)
- **Roles (obrigat√≥rio)**: Sele√ß√£o m√∫ltipla com popover e command

**Interface de Sele√ß√£o de Roles:**
- Popover com interface de comando
- Busca em tempo real
- Sele√ß√£o m√∫ltipla com checkboxes
- Op√ß√£o para limpar sele√ß√£o
- Indicador visual de itens selecionados

### UpdateUser
Modal para edi√ß√£o de usu√°rios.

**Campos:**
- Nome (obrigat√≥rio)
- Email (obrigat√≥rio, √∫nico)
- Status (ACTIVE/SUSPENDED)
- **Roles (obrigat√≥rio)**: Sele√ß√£o m√∫ltipla com popover e command

**Interface de Sele√ß√£o de Roles:**
- Mesma interface do CreateUser para consist√™ncia
- Pr√©-sele√ß√£o dos roles atuais do usu√°rio
- Valida√ß√£o de pelo menos um role

### DeleteUser
Modal de confirma√ß√£o para exclus√£o.

**Funcionalidades:**
- Confirma√ß√£o antes da exclus√£o
- Exclus√£o l√≥gica (soft delete)
- Feedback visual

### ListRoles
Tabela responsiva com listagem de fun√ß√µes.

**Funcionalidades:**
- Pagina√ß√£o autom√°tica
- Busca em tempo real
- A√ß√µes de edi√ß√£o e exclus√£o
- Persist√™ncia de estado no localStorage

### CreateRole
Modal para cria√ß√£o de fun√ß√µes.

**Campos:**
- Nome (obrigat√≥rio)
- Slug (obrigat√≥rio, √∫nico, convertido para mai√∫sculas)

### UpdateRole
Modal para edi√ß√£o de fun√ß√µes.

**Campos:**
- Nome (obrigat√≥rio)
- Slug (obrigat√≥rio, √∫nico, convertido para mai√∫sculas)

### DeleteRole
Modal de confirma√ß√£o para exclus√£o de fun√ß√µes.

**Funcionalidades:**
- Confirma√ß√£o antes da exclus√£o
- Verifica√ß√£o de usu√°rios associados
- Feedback visual

## ‚úÖ Valida√ß√µes

### Schemas Zod

#### createUserSchema
```typescript
{
  name: string; // m√≠nimo 1 caractere
  email: string; // email v√°lido
  password: string; // m√≠nimo 6 caracteres
  status: "ACTIVE" | "SUSPENDED";
  roles: string[]; // array n√£o vazio
}
```

#### updateUserSchema
```typescript
{
  name: string; // m√≠nimo 1, m√°ximo 255 caracteres
  email: string; // email v√°lido, m√°ximo 255 caracteres
  status: "ACTIVE" | "SUSPENDED";
  roles: string[]; // array n√£o vazio
}
```

#### changePasswordSchema
```typescript
{
  currentPassword: string;
  newPassword: string; // m√≠nimo 6 caracteres
  confirmPassword: string; // deve coincidir com newPassword
}
```

### Regras de Neg√≥cio
- Email deve ser √∫nico (exceto pr√≥prio na edi√ß√£o)
- Senha m√≠nima de 6 caracteres
- **Pelo menos um role √© obrigat√≥rio**
- Nome e email s√£o obrigat√≥rios
- Valida√ß√£o de usu√°rio existente antes de opera√ß√µes
- Slug de fun√ß√£o deve ser √∫nico
- Nome de fun√ß√£o √© obrigat√≥rio
- Valida√ß√£o de fun√ß√£o existente antes de opera√ß√µes
- Prote√ß√£o contra exclus√£o de fun√ß√µes com usu√°rios associados

### Valida√ß√µes Server-Side
- Verifica√ß√£o de email duplicado
- Valida√ß√£o de usu√°rio existente
- Verifica√ß√£o de soft delete
- Transa√ß√µes para opera√ß√µes complexas
- Verifica√ß√£o de slug duplicado
- Valida√ß√£o de fun√ß√£o existente
- Verifica√ß√£o de usu√°rios associados antes da exclus√£o
- **Valida√ß√£o de array de roles n√£o vazio**

## üîê Permiss√µes

A feature de usu√°rios utiliza o sistema de permiss√µes do NextAuth:

### Permiss√µes Necess√°rias
- `user:read` - Visualizar usu√°rios
- `user:create` - Criar usu√°rios
- `user:update` - Atualizar usu√°rios
- `user:delete` - Excluir usu√°rios
- `role:read` - Visualizar fun√ß√µes
- `role:create` - Criar fun√ß√µes
- `role:update` - Atualizar fun√ß√µes
- `role:delete` - Excluir fun√ß√µes

### Verifica√ß√£o de Permiss√µes
```typescript
if (!(await can("user:read"))) {
  redirect("/dashboard?error=no_permission");
}
```

## üöÄ Como Usar

### 1. Acessar a P√°gina
Navegue para `/users` (requer permiss√£o `user:read`)

### 2. Listar Usu√°rios
- A tabela carrega automaticamente
- Use a busca para filtrar por nome/email
- Use os filtros de fun√ß√£o para refinar resultados (sele√ß√£o m√∫ltipla)
- **Roles s√£o exibidos com limite de 2 vis√≠veis + indicador de quantidade**

### 3. Criar Usu√°rio
- Clique no bot√£o "+" no canto superior direito
- Preencha todos os campos obrigat√≥rios
- **Selecione um ou mais fun√ß√µes usando o popover de sele√ß√£o**
- Clique em "Criar"

### 4. Editar Usu√°rio
- Clique no √≠cone de edi√ß√£o na linha do usu√°rio
- Modifique os campos desejados
- **Gerencie os fun√ß√µes usando a interface de sele√ß√£o m√∫ltipla**
- Clique em "Salvar"

### 5. Excluir Usu√°rio
- Clique no √≠cone de lixeira na linha do usu√°rio
- Confirme a exclus√£o no modal
- O usu√°rio ser√° marcado como deletado

### 6. Gerenciar Fun√ß√µes
Navegue para `/roles` (requer permiss√£o `role:read`)

#### Listar Fun√ß√µes
- A tabela carrega automaticamente
- Use a busca para filtrar por nome/slug

#### Criar Fun√ß√£o
- Clique no bot√£o "+" no canto superior direito
- Preencha nome e slug (obrigat√≥rios)
- O slug ser√° convertido automaticamente para mai√∫sculas
- Clique em "Criar"

#### Editar Fun√ß√£o
- Clique no √≠cone de edi√ß√£o na linha do fun√ß√£o
- Modifique os campos desejados
- Clique em "Salvar"

#### Excluir Fun√ß√£o
- Clique no √≠cone de lixeira na linha do fun√ß√£o
- Confirme a exclus√£o no modal
- O fun√ß√£o ser√° exclu√≠do (apenas se n√£o houver usu√°rios associados)

## üîß Configura√ß√µes

### Vari√°veis de Ambiente
```env
DATABASE_URL="postgresql://..."
```

### Depend√™ncias
- `@prisma/client` - ORM para banco de dados
- `@tanstack/react-query` - Gerenciamento de estado
- `zod` - Valida√ß√£o de schemas
- `bcrypt` - Hash de senhas
- `next-auth` - Autentica√ß√£o e permiss√µes
- `@radix-ui/react-popover` - Componentes de interface
- `@radix-ui/react-command` - Interface de comando

## üìù Notas T√©cnicas

### Performance
- Consultas otimizadas com √≠ndices no banco
- Pagina√ß√£o para grandes volumes de dados
- Queries em paralelo quando poss√≠vel
- **Limita√ß√£o de exibi√ß√£o de roles para melhor performance visual**

### Seguran√ßa
- Senhas criptografadas com bcrypt
- Valida√ß√£o server-side rigorosa
- Verifica√ß√£o de permiss√µes em todas as opera√ß√µes
- **Valida√ß√£o de array de roles para prevenir dados inv√°lidos**

### Auditoria
- Todas as opera√ß√µes s√£o registradas no AuditLog
- Soft delete para preservar hist√≥rico
- Timestamps autom√°ticos
- **Registro de mudan√ßas em m√∫ltiplos roles**

### UX/UI
- Interface responsiva e moderna
- Feedback visual para todas as a√ß√µes
- Estados de loading e erro
- Persist√™ncia de configura√ß√µes do usu√°rio
- **Interface avan√ßada de sele√ß√£o m√∫ltipla de roles**
- **Exibi√ß√£o otimizada de roles na tabela**
- **Popover com command para melhor usabilidade**

### Mudan√ßas Recentes (v2.0)
- **Suporte a m√∫ltiplos roles por usu√°rio**
- **Novo schema com roles como array**
- **Interface de sele√ß√£o com popover e command**
- **Limita√ß√£o de exibi√ß√£o de roles na tabela (m√°ximo 2)**
- **Melhorias na valida√ß√£o e feedback visual**
- **Consist√™ncia entre componentes CreateUser e UpdateUser**
